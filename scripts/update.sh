#!/bin/bash

# ============================================
# –°–ö–†–ò–ü–¢ –û–ë–ù–û–í–õ–ï–ù–ò–Ø –ò–ò-–ê–ì–ï–ù–¢–ê –ï–õ–ï–ù–ê
# ============================================

# –¶–≤–µ—Ç–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}============================================${NC}"
echo -e "${BLUE}üîÑ –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ò-–ê–ì–ï–ù–¢–ê –ï–õ–ï–ù–ê${NC}"
echo -e "${BLUE}============================================${NC}"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è Git
if ! command -v git &> /dev/null; then
    echo -e "${RED}‚ùå Git –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω${NC}"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [ ! -d ".venv" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ${NC}"
    echo "   –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ: ./scripts/setup.sh"
    exit 1
fi

# –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
echo -e "${BLUE}üîß –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è...${NC}"
source .venv/bin/activate
echo -e "${GREEN}‚úÖ –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ${NC}"
echo ""

# –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é
if [ -f "VERSION" ]; then
    OLD_VERSION=$(cat VERSION)
    echo -e "${BLUE}üìå –¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è: ${OLD_VERSION}${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è –§–∞–π–ª –≤–µ—Ä—Å–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω${NC}"
    OLD_VERSION="0.0.0"
fi
echo ""

# –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∏–∑ Git
echo -e "${BLUE}üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è...${NC}"
git fetch origin main

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
LOCAL=$(git rev-parse HEAD)
REMOTE=$(git rev-parse origin/main)

if [ "$LOCAL" = "$REMOTE" ]; then
    echo -e "${GREEN}‚úÖ –£ –≤–∞—Å –∞–∫—Ç—É–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è. –û–±–Ω–æ–≤–ª–µ–Ω–∏–π –Ω–µ—Ç.${NC}"
    
    # –í—Å–µ —Ä–∞–≤–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    echo ""
    echo -e "${BLUE}üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...${NC}"
    pip install -r requirements.txt --upgrade
    echo -e "${GREEN}‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã${NC}"
else
    echo -e "${YELLOW}üì¢ –ù–∞–π–¥–µ–Ω—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è${NC}"
    echo ""
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ configs (–µ—Å–ª–∏ –µ—Å—Ç—å)
    if [ -d "configs" ]; then
        echo -e "${BLUE}üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...${NC}"
        cp -r configs configs_backup
        echo -e "${GREEN}‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ configs_backup${NC}"
    fi
    
    # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞
    echo -e "${BLUE}üì• –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞...${NC}"
    git pull origin main
    
    # –ü–æ–ª—É—á–∞–µ–º –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é
    if [ -f "VERSION" ]; then
        NEW_VERSION=$(cat VERSION)
        echo -e "${GREEN}‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ —Å –≤–µ—Ä—Å–∏–∏ ${OLD_VERSION} –¥–æ ${NEW_VERSION}${NC}"
    else
        NEW_VERSION=$(git rev-parse --short HEAD)
        echo -e "${GREEN}‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ –¥–æ –∫–æ–º–º–∏—Ç–∞: ${NEW_VERSION}${NC}"
    fi
    echo ""
    
    # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    echo -e "${BLUE}üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...${NC}"
    pip install -r requirements.txt --upgrade
    echo -e "${GREEN}‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã${NC}"
    echo ""
    
    # –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    if [ -d "configs_backup" ]; then
        echo -e "${BLUE}‚öôÔ∏è –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...${NC}"
        cp -r configs_backup/* configs/ 2>/dev/null || true
        rm -rf configs_backup
        echo -e "${GREEN}‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞${NC}"
    fi
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –º–æ–¥—É–ª—è
echo ""
echo -e "${BLUE}üîä –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –º–æ–¥—É–ª—è...${NC}"
if [ ! -f "simple_voice.py" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è –ì–æ–ª–æ—Å–æ–≤–æ–π –º–æ–¥—É–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω${NC}"
    echo "   –°–∫–∞—á–∞–π—Ç–µ simple_voice.py –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –µ–≥–æ"
else
    echo -e "${GREEN}‚úÖ –ì–æ–ª–æ—Å–æ–≤–æ–π –º–æ–¥—É–ª—å: simple_voice.py${NC}"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ RHVoice
if command -v RHVoice-test &> /dev/null; then
    echo -e "${GREEN}‚úÖ RHVoice: —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–≥–æ–ª–æ—Å –ï–ª–µ–Ω—ã)${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è RHVoice –Ω–µ –Ω–∞–π–¥–µ–Ω${NC}"
    echo "   –î–ª—è –≥–æ–ª–æ—Å–∞ –ï–ª–µ–Ω—ã –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:"
    echo "   sudo apt install rhvoice rhvoice-russian"
fi

# –ü—Ä–∞–≤–∞ –Ω–∞ —Å–∫—Ä–∏–ø—Ç—ã
echo ""
echo -e "${BLUE}üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤ –Ω–∞ —Å–∫—Ä–∏–ø—Ç—ã...${NC}"
chmod +x scripts/*.sh 2>/dev/null || true
chmod +x start_elena.py 2>/dev/null || true
echo -e "${GREEN}‚úÖ –ü—Ä–∞–≤–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã${NC}"

echo ""
echo -e "${BLUE}============================================${NC}"
echo -e "${GREEN}‚úÖ –û–ë–ù–û–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û!${NC}"
echo -e "${BLUE}============================================${NC}"
echo ""
echo -e "${BLUE}üéÄ –ï–ª–µ–Ω–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ!${NC}"
echo ""
echo "–î–ª—è –∑–∞–ø—É—Å–∫–∞:"
echo "  source .venv/bin/activate"
echo "  python start_elena.py"
echo ""
echo "–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞:"
echo "  ./scripts/run.sh"
echo ""